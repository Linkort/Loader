# Устройство для подготовки плат/модулей расширения ПЛК.
![Loader v17](doc/Loader%20v17.png)
## Описание
Устройство разработано на основе Wemos D1 Mini Lite(ESP8266).
Устройство предназначено для подготовки плат/модулей расширения к работе в составе ПЛК <br> 

Loader позволяет:<br> 
- Смена Modbus адреса платы/модуля расширения ПЛК;
- Загрузка прошивки на плату/модуль на основе STM32 используя встроенный bootloader микроконтроллера.


![Loader v18](doc/Loader%20v18.png)<br>
На лицевой стороне расположены дисплей и кнопки управления:    
- Кнопки UP/ DOWN - изменение значений на дисплее;<br>
- Кнопка READ - Команда на чтение;<br>
- Кнопка WRITE - Команда на запись;<br>
- Кнопка POWER - Отключение питания на плате/модуле. Рекомендуется для перезагрузки целевой платы. <br>

Разъемы подключения:<br>
- X1 - Разъем питания 9-30V DC;<br>
- X2, X3 - Разъемы подключения модуля расширения;<br>
- X4 - Разъем подключения платы расширения;<br>
- USB type C - Разъем питания / программирования.<br>
>**При питании через кабель USB type C - работа возможна только с платами расширения.**<br>
>**Одновременное подключение двух источников питания запрещено.**


## Инструкция

### Режимы работы
Loader имеет три режима работы:
  - Режим смены адреса. Текст на дисплее "Adr". Loader по протоколу Modbus RTU может прочитать / записать Modbus адрес устройства. Связь ведется с помощью broadcast адреса - 255, поддерживаемый платами/модулями расширения. Данный режим основной. Текст на дисплее "FLS". Loader по умолчанию переходит в данный режим при включении.<br>
  - Режим прошивки. Loader по протоколу USART(AN3155) записывает прошивку в микроконтроллер STM32 на плате расширения. Для перехода в данный режим необходимо зажать кнопки UP и DOWN в режиме смены адреса. Повторение действия приведет к переходу в "Режим смены адреса".<br>
  - Режим точки доступа. Текст на дисплее "AP". Необходим для загрузки в Loader прошивок для плат расширения. Для перехода в данный режим необходимо подать питание на устройство при зажатой кнопке READ или WRITE. При включении активируется точка доступа (ssid: Loader, pass: 11111111). После подключения с помощью FTP клиента можно загрузить в Loader прошивки STM32.<br>

### Смена адреса платы
1\. Подать питание на Loader.<br>
2\. Настроить плату/модуль<br>
Для платы расширения: <br>
- Установить SW1.1 - в положение ON / UP. <br>
- Установить SW1.2 - в положение OFF / DOWN<br>

Для модуля расширения: <br>
- Установить Джампер J4.<br>
- Снять Джампер J3.<br>
<details>
  <summary> Назначение переключателей</summary>
  
  |                                         | Переключатель                                  | Переключатель                            |
  | --------------------------------------- | ---------------------------------------------- | ---------------------------------------- |
  | Плата <br>Расширения                    | Джампер J4                                     | Джампер J3                               |
  | Модуль <br>расширения                   | SW1.1                                          | SW1.2                                    |
  | Назначение                              | Запись настроек в <br>энергонезависимую память | Применение  скорости <br>из памяти       |
  | Положение ON / UP<br>Джампер установлен | Разрешено                                      | Разрешено                                |
  | Положение OFF / DOWN<br>Джампер снят    | Запрещено                                      | Запрещено.<br>Скорость для обмена 115200 |
  
</details>

3\. Подключить плату/модуль<br>
Плату расширения в разъем X4. Модуль расширения в разъем X2, X3. <br>
>**Одновременное подключение платы расширения и модуля расширения не допустимо.**<br>

4\. Нажать кнопку READ - прочитать адрес платы/модуля<br>
  При успешном чтении - на дисплее отобразится текущий адрес платы/модуля. <br>
  
5\. Изменить адрес на дисплее устройства на требуемый.<br>

6\. Нажать кнопку WRITE - записать адрес в плату расширения<br>
Сообщение "Suc" сообщает об успешном изменении адреса.

### Прошивка платы
1\. Подать питание на Loader.<br>
2\. Переключиться в режим прошивки: нажать одновременно кнопки UP и DOWN.<br>
3\. Подключить плату/модуль<br>
4\. Замкнуть джампер boot(J1) на плате/модуле. Нажать кратковременно кнопку RWR на устройстве. Можно снять джампер. В режиме прошивки на платах расширения индикатор связи будет гореть постоянно. Иначе - повторить операцию.<br>
5\. Выбрать на дисплее Loader'a нужную прошивку и нажать WRITE. Сообщение "Suc" сообщает об успешной прошивке.<br>

### Индикация на дисплее
| Индикация на дисплее | Расшифровка                                                                    |
| -------------------- | ------------------------------------------------------------------------------ |
| "8.8.8."             | Процедура включения устройства                                                 |
| "---"                | Устройство готово к работе                                                     |
| "Adr"                | Loader в режиме смены адреса                                                   |
| "FLS"                | Loader в режиме прошивки плат расширения                                       |
| "AP"                | Loader в режиме точки доступа                                                  |
<details>
  <summary>Перечень ошибок на дисплее</summary>

| Индикация | Режим смены адреса                                                             | Режим прошивки                  |
| --------- | ------------------------------------------------------------------------------ | ------------------------------- |
| "Er0"     | Таймаут, нет ответа от устройства.                                             | -                               |
| "Er1"     | Принятый код функции не может быть обработан.                                  | Ошибка файла прошивки           |
| "Er2"     | Регистр данных, указанный в запросе, недоступен.                               | Ошибка при подключении к STM32  |
| "Er3"     | Значение, содержащееся в поле данных запроса, является недопустимой величиной. | Неудалось очистить память STM32 |
| "Er4"     | Невосстанавливаемая ошибка, slave не смог выполнить затребованное действие.    | Ошибка при записи прошивки      |
| "Er5"     | Адрес устройства в ответе не соответствует ожидаемому.                         | -                               |
| "Er6"     | Код функции в ответе не соответствует коду запроса.                            | -                               |
| "Er7"     | Ошибка CRC в ответе.                                                           | -                               |

</details>



## Подготовка к работе
1\. Используя Platformio загрузить ППО на ESP8266.<br>
2\. Включить Loader в режиме точки доступа. Подать питание с зажатой кнопкой READ / WRITE.<br>
3\. Loader активирует точку доступа (ssid: Loader, pass: 11111111).<br>
4\. Используя FTP клиент загрузить на устройство прошивки.<br>



## Дополнительно

<details>
  <summary>Карта регистров</summary>

Запись/Чтение происходит согласно карте регистров плат расширения:
| Адрес<br>Modbus | Описание                                  | Кнопка READ               | Кнопка WRITE                         |
| --------------- | ----------------------------------------- | ------------------------- | ------------------------------------ |
| 1               | Modbus-адрес платы                        | Чтение и вывод на дисплей | Запись значения с дисплея            |
| 2               | Делитель скорости коммуникационного порта | -                         | Запись фиксированного делителя - 240 |

Функция 0x03 Read Holding Registers(4x). Настройки подключения: 115200 8N1.
</details>



